<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ClueMatch</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
<style>
/* existing styles unchanged */
button#voiceBtn {
  position: fixed;
  top: 0;
  right: 0;
  margin: 1rem;
  padding: 0.6rem 1rem;
  border-radius: 10px;
  background: #0077cc;
  color: white;
  border: none;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
<h1>ClueMatch</h1>

<div id="tabs">
  <div class="tab active" data-source="members">Members</div>
  <div class="tab" data-source="setters">Setters</div>
  <div class="tab" data-source="book">Book</div>
</div>

<div id="assessmentCounts">No: 0 | OK: 0 | Great: 0</div>
<div id="progress"><div id="progressBar"></div></div>
<div id="progressCount"></div>
<div id="flashMessage"></div>

<div id="card" style="display:none;"></div>

<div id="buttons">
  <button onclick="animateSwipe('left', () => recordAssessment('No'))">No</button>
  <button onclick="animateSwipe('right', () => recordAssessment('OK'))">OK</button>
  <button onclick="animateSwipe('down', () => recordAssessment('Great'))">Great</button>
  <button onclick="openNote()">Note</button>
  <button onclick="undoAssessment()" id="btnUndo">Undo</button>
</div>

<button id="exportBtn" onclick="exportCSV()">Download Reviewed CSV</button>
<button id="resetBtn" onclick="resetProgress()">Reset Progress</button>
<button id="voiceBtn" onclick="toggleVoiceMode()">ðŸŽ¤ Voice Mode</button>

<div id="noteOverlay">
  <textarea id="noteText" placeholder="Write your note here..."></textarea>
  <button onclick="saveNote()">OK</button>
</div>

<script>
// === existing vars ===
let clues = [];
let current = 0;
const history = [];
const counts = { No:0, OK:0, Great:0 };
const card = document.getElementById("card");
const flash = document.getElementById("flashMessage");
const progressBar = document.getElementById("progressBar");
const progressCount = document.getElementById("progressCount");
const assessmentCounts = document.getElementById("assessmentCounts");
let currentSource = "members";

let voiceMode = false;
let recognition;

const synth = window.speechSynthesis;
function speak(text){
  if(!voiceMode) return;
  const utter = new SpeechSynthesisUtterance(text);
  synth.speak(utter);
}

function initRecognition(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) { alert("Speech recognition not supported in this browser."); return null; }
  const recog = new SpeechRecognition();
  recog.continuous = true;
  recog.interimResults = false;
  recog.lang = "en-US";
  recog.onresult = (event)=>{
    const transcript = event.results[event.results.length-1][0].transcript.trim().toLowerCase();
    handleVoiceCommand(transcript);
  };
  return recog;
}

function toggleVoiceMode(){
  voiceMode = !voiceMode;
  if(voiceMode){
    recognition = initRecognition();
    if(recognition){ recognition.start(); }
    document.getElementById("voiceBtn").style.background="#cc0000";
    speak("Voice mode enabled. First clue:");
    readCurrentClue();
  } else {
    if(recognition){ recognition.stop(); }
    document.getElementById("voiceBtn").style.background="#0077cc";
    speak("Voice mode disabled.");
  }
}

function handleVoiceCommand(cmd){
  if(cmd.includes("no")) animateSwipe("left",()=>recordAssessment("No"));
  else if(cmd.includes("ok")) animateSwipe("right",()=>recordAssessment("OK"));
  else if(cmd.includes("great")) animateSwipe("down",()=>recordAssessment("Great"));
  else if(cmd.includes("answer")) toggleAnswer(document.getElementById("answer"));
  else if(cmd.includes("repeat")) readCurrentClue();
  else if(cmd.includes("note")) openNote();
}

function readCurrentClue(){
  if(current>=clues.length){ speak("All done."); return; }
  const clue = clues[current];
  speak(`Clue: ${clue.Clue}. Say Answer to hear the answer, or No, OK, or Great.`);
}

// === existing functions (loadSheet, updateCounts, showNext, etc.) remain the same ===
// inside showNext, after displaying card:
const _oldShowNext = showNext;
showNext = function(){
  if(current>=clues.length){
    card.innerHTML = "<strong>All done!</strong>";
    card.style.display="block";
    document.getElementById("buttons").style.display="none";
    progressBar.style.width="100%";
    progressCount.textContent=`${clues.length}/${clues.length}`;
    if(voiceMode) speak("All done. You have finished all clues.");
    return;
  }
  const clue = clues[current];
  card.innerHTML = `
    <p>${clue.Clue}</p>
    <p><strong>Answer:</strong> <span id="answer" class="hidden" onclick="toggleAnswer(this)" data-answer="${clue.Answer}">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span></p>
    <p id="writer">${clue.Writer}</p>
  `;
  card.style.display="block"; card.className=''; void card.offsetWidth; card.classList.add('enter');
  updateProgress();
  if(voiceMode) readCurrentClue();
}

</script>
</body>
</html>
