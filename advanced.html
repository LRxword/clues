<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>cluesmash</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://hammerjs.github.io/dist/hammer.min.js"></script>

<style>
  body { 
    margin: 0; font-family: 'Montserrat', sans-serif; background: #cce7ff; 
    min-height: 100dvh; display: flex; flex-direction: column; align-items: center; 
    padding: 2rem 1rem 7rem; color: white; user-select: none; overflow-x: hidden;
  }
  #title-wrapper { margin-bottom: 0.5rem; }
  #title-wrapper img { height: 40px; }
  #tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
  .tab {
    padding: 0.6rem 1.2rem; font-weight: 700; border-radius: 16px; cursor: pointer; 
    background: #fff; color: #000; border: 2px solid #000; box-shadow: 4px 4px 0 #000;
  }
  .tab.active { background: #fff2b3; }
  #assessmentCounts { font-size: 1.1rem; margin-bottom: 0.5rem; color: #222; }
  #progress { width: 90vw; max-width: 500px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
  #progressBar { height: 100%; width: 0%; background: #ffe6e6; transition: width 0.3s ease; }
  #progressCount { font-size: 1.3rem; margin-bottom: 1.5rem; color: #222; }
  #card {
    background: white; color: #222; border: 3px solid #000; border-radius: 20px;
    padding: 2rem 1.5rem; font-size: 2rem; line-height: 1.4; box-shadow: 6px 6px 0 #000; 
    text-align: center; width: 80vw; max-width: 380px; margin-bottom: 2rem;
    transition: transform 0.4s ease, opacity 0.4s ease;
  }
  #card.swipe-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
  #card.swipe-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
  #card.swipe-down { transform: translateY(150%) rotate(15deg); opacity: 0; }
  #answer { cursor: pointer; padding: 0 0.4em; border-radius: 6px; background: black; color: black; transition: 0.3s; }
  #answer.revealed { background: none; color: #222; }
  #writer { font-size: 1.2rem; color: #555; margin-top: 1rem; }
  #buttons { display: flex; gap: 2.2rem; font-size: 2.5rem; }
  .emoji-btn { cursor: pointer; transition: transform 0.15s ease; text-shadow: 2px 2px 0 #000; }
  .emoji-btn:active { transform: scale(1.3); }
  #bottomButtons { position: fixed; bottom: 0; width: 100%; display: flex; z-index: 10; }
  #bottomButtons button { flex: 1; padding: 1rem; color: white; border: none; cursor: pointer; }
  #exportBtn { background: #222; }
  #resetBtn { background: #e53935; }
  #flashMessage { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; opacity: 0; transition: 0.4s; pointer-events: none; }
  #flashMessage.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
</style>
</head>
<body>

<div id="title-wrapper"><img src="https://i.imgur.com/3cTvC1h.png" alt="logo"></div>
<div id="tabs">
  <div class="tab" data-view="all">All</div>
  <div class="tab" data-view="stars">Stars</div>
</div>
<div id="assessmentCounts">No: 0 | Workshop: 0 | Perfect: 0</div>
<div id="progress"><div id="progressBar"></div></div>
<div id="progressCount"></div>
<div id="flashMessage"></div>
<div id="card" style="display:none;"></div>

<div id="buttons">
  <span class="emoji-btn" onclick="animateSwipe('left', () => record('No'))">‚ùå</span>
  <span class="emoji-btn" onclick="animateSwipe('right', () => record('Workshop'))">üí°</span>
  <span class="emoji-btn" onclick="animateSwipe('down', () => record('Perfect'))">‚≠ê</span>
  <span class="emoji-btn" onclick="undo()">‚Ü©Ô∏è</span>
</div>

<div id="bottomButtons">
  <button id="exportBtn" onclick="exportCSV()">Download CSV</button>
  <button id="resetBtn" onclick="resetProgress()">Reset</button>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsSUD7PgliCuhNkFFA3nyjes14LHlg1Gp2wuLlG5DU6FIp4CwP0lbrmGLuGe_DlhlbdM6fh_xwb2sZ/pub?output=csv";
const PROGRESS_KEY = "clueMatch_simple_v1";
const VIEW_KEY = "clueMatchView";
const STARS_KEY = "clueMatchStars";

let allClues = [], clues = [], currentIndex = 0, currentKey = "";
let viewMode = localStorage.getItem(VIEW_KEY) || "all";
let progress = JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{"byId":{}}');
let setterStars = JSON.parse(localStorage.getItem(STARS_KEY) || '{}');
const history = [];

const card = document.getElementById("card");
const flash = document.getElementById("flashMessage");

function buzz(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }
function makeKey(r){ return r.Id ? `ID¬ß${r.Id}` : `H¬ß${r.Clue}${r.Answer}`; }

async function loadSheet() {
  card.textContent = 'Loading...';
  try {
    const res = await fetch("https://corsproxy.io/?" + encodeURIComponent(SHEET_URL + `&_=${Date.now()}`), { cache: "no-store" });
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    
    allClues = parsed.data.map(r => ({
      Id: r.id || r.Id || "",
      Clue: r.clue || r.Clue || "",
      Answer: r.answer || r.Answer || "",
      Writer: r.setter_name || r.Writer || "",
      Assessment: progress.byId[r.id || r.Id]?.Assessment || ""
    })).filter(r => r.Clue && r.Answer);

    rebuild();
  } catch(e) { alert("Load error"); }
}

function rebuild(keepKey = "") {
  clues = allClues.filter(c => !c.Assessment);
  if (viewMode === "stars") clues = clues.filter(c => setterStars[c.Writer.toLowerCase().trim()]);
  
  currentIndex = keepKey ? clues.findIndex(c => makeKey(c) === keepKey) : 0;
  if (currentIndex < 0) currentIndex = 0;
  render();
}

function render() {
  if (!clues.length || currentIndex >= clues.length) {
    card.innerHTML = "<strong>Done!</strong>";
    document.getElementById("buttons").style.display = "none";
    return;
  }
  const c = clues[currentIndex];
  const isStarred = setterStars[c.Writer.toLowerCase().trim()];
  card.innerHTML = `<p>${c.Clue}</p><p><strong>Ans:</strong> <span id="answer" onclick="this.classList.toggle('revealed')">${c.Answer}</span></p><p id="writer">${c.Writer} ${isStarred?'‚≠ê':''}</p>`;
  card.style.display = "block";
  updateUI();
}

function record(val) {
  const c = clues[currentIndex];
  c.Assessment = val;
  progress.byId[c.Id] = { Assessment: val };
  history.push(makeKey(c));
  localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
  rebuild();
}

function undo() {
  const key = history.pop();
  if (!key) return;
  const id = key.replace("ID¬ß","");
  const c = allClues.find(cl => cl.Id === id);
  if (c) { c.Assessment = ""; delete progress.byId[id]; }
  localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
  rebuild(key);
}

function updateUI() {
  const counts = { No:0, Workshop:0, Perfect:0 };
  allClues.forEach(c => { if(counts[c.Assessment] !== undefined) counts[c.Assessment]++; });
  document.getElementById("assessmentCounts").textContent = `No: ${counts.No} | Work: ${counts.Workshop} | Star: ${counts.Perfect}`;
  document.getElementById("progressCount").textContent = `${clues.length} left`;
  document.getElementById("progressBar").style.width = `${((allClues.length - clues.length)/allClues.length)*100}%`;
}

function animateSwipe(dir, cb) {
  buzz();
  card.classList.add(`swipe-${dir}`);
  flash.textContent = {left:'‚ùå', right:'üí°', down:'‚≠ê'}[dir];
  flash.classList.add("show");
  setTimeout(() => { card.className=''; flash.classList.remove("show"); cb(); }, 400);
}

function exportCSV() {
  const data = allClues.filter(c => c.Assessment).map(c => ({ id: c.Id, clue: c.Clue, answer: c.Answer, setter: c.Writer, result: c.Assessment }));
  const blob = new Blob(['\ufeff' + Papa.unparse(data)], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "reviews.csv";
  a.click();
}

function resetProgress() {
  if (confirm("Reset everything?")) { localStorage.clear(); location.reload(); }
}

const mc = new Hammer(document.body);
mc.get("swipe").set({ direction: Hammer.DIRECTION_ALL });
mc.on("swipeleft", () => animateSwipe('left', () => record('No')));
mc.on("swiperight", () => animateSwipe('right', () => record('Workshop')));
mc.on("swipedown", () => animateSwipe('down', () => record('Perfect')));

document.querySelectorAll(".tab").forEach(t => t.onclick = () => {
  viewMode = t.dataset.view;
  localStorage.setItem(VIEW_KEY, viewMode);
  document.querySelectorAll(".tab").forEach(i => i.classList.toggle("active", i === t));
  rebuild();
});

window.onload = loadSheet;
</script>
</body>
</html>
