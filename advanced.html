<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>cluesmash</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://hammerjs.github.io/dist/hammer.min.js"></script>

<style>
  body {
    margin: 0; font-family: 'Montserrat', sans-serif; background: #cce7ff;
    min-height: 100dvh; display: flex; flex-direction: column; align-items: center;
    padding: 2rem 1rem 7rem; color: white; user-select: none; overflow-x: hidden;
  }
  body.modal-open { position: fixed; width: 100%; overflow: hidden; }

  #title-wrapper { margin-bottom: 0.5rem; }
  #title-wrapper img { height: 40px; }

  #tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
  .tab {
    padding: 0.6rem 1.2rem; font-weight: 700; border-radius: 16px; cursor: pointer;
    background: #fff; color: #000; border: 2px solid #000; box-shadow: 4px 4px 0 #000;
  }
  .tab.active { background: #fff2b3; }

  #assessmentCounts { font-size: 1.1rem; margin-bottom: 0.5rem; color: #222; }

  #progress { width: 90vw; max-width: 500px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
  #progressBar { height: 100%; width: 0%; background: #ffe6e6; transition: width 0.3s ease; }
  #progressCount { font-size: 1.3rem; margin-bottom: 1.5rem; color: #222; }

  #card {
    background: white; color: #222; border: 3px solid #000; border-radius: 20px;
    padding: 2rem 1.5rem; font-size: 2rem; line-height: 1.4; box-shadow: 6px 6px 0 #000;
    text-align: center; width: 80vw; max-width: 380px; margin-bottom: 2rem;
    transition: transform 0.4s ease, opacity 0.4s ease;
    min-height: 220px; /* keeps emoji row from bouncing */
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  #card.swipe-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
  #card.swipe-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
  #card.swipe-down { transform: translateY(150%) rotate(15deg); opacity: 0; }

  #answer { cursor: pointer; padding: 0 0.4em; border-radius: 6px; background: black; color: black; transition: 0.3s; }
  #answer.revealed { background: none; color: #222; }

  #writer { font-size: 1.2rem; color: #555; margin-top: 1rem; display: inline-flex; gap: .35rem; align-items: center; justify-content: center; }
  #writerStar { font-size: 1.15rem; line-height: 1; }

  #buttons { display: flex; gap: 1.8rem; font-size: 2.5rem; align-items: center; margin-bottom: 1rem; }
  .emoji-btn { cursor: pointer; transition: transform 0.15s ease; text-shadow: 2px 2px 0 #000; }
  .emoji-btn:hover, .emoji-btn:active { transform: scale(1.25); }

  #bottomButtons { position: fixed; bottom: 0; width: 100%; display: flex; z-index: 10; }
  #bottomButtons button { flex: 1; padding: 1rem; color: white; border: none; cursor: pointer; }
  #exportBtn { background: #222; }
  #resetBtn { background: #e53935; }

  #flashMessage { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; opacity: 0; transition: 0.4s; pointer-events: none; }
  #flashMessage.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }

  #noteOverlay {
    display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
    width: 80%; max-width: 320px; background: white; border-radius: 20px;
    padding: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 1000; border: 3px solid #000;
  }
  #noteText { width: 90%; height: 100px; font-size: 1.2rem; padding: 0.5rem; border: 2px solid #000; border-radius: 10px; resize: none; font-family: inherit; }
  #noteOverlay button { margin-top: 1rem; width: 100%; padding: 0.7rem; background: #222; color: #fff; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
</style>
</head>

<body>
<div id="title-wrapper"><img src="https://i.imgur.com/3cTvC1h.png" alt="logo"></div>

<div id="tabs">
  <div class="tab" data-view="all">All</div>
  <div class="tab" data-view="stars">Stars</div>
</div>

<div id="assessmentCounts">No: 0 | Workshop: 0 | Perfect: 0</div>
<div id="progress"><div id="progressBar"></div></div>
<div id="progressCount"></div>
<div id="flashMessage"></div>
<div id="card" style="display:none;"></div>

<div id="buttons">
  <span class="emoji-btn" onclick="animateSwipe('left', () => record('No'))" aria-label="No" role="button" tabindex="0">‚ùå</span>
  <span class="emoji-btn" onclick="animateSwipe('right', () => record('Workshop'))" aria-label="Workshop" role="button" tabindex="0">üí°</span>
  <span class="emoji-btn" onclick="animateSwipe('down', () => record('Perfect'))" aria-label="Perfect" role="button" tabindex="0">‚≠ê</span>
  <span class="emoji-btn" onclick="openNote()" aria-label="Note" role="button" tabindex="0">‚úèÔ∏è</span>
  <span class="emoji-btn" onclick="undo()" aria-label="Undo" role="button" tabindex="0">‚Ü©Ô∏è</span>
</div>

<div id="bottomButtons">
  <button id="exportBtn" onclick="exportCSV()">Download CSV</button>
  <button id="resetBtn" onclick="resetProgress()">Reset</button>
</div>

<div id="noteOverlay">
  <textarea id="noteText" placeholder="Add a note..."></textarea>
  <button onclick="saveNote()">Save</button>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsSUD7PgliCuhNkFFA3nyjes14LHlg1Gp2wuLlG5DU6FIp4CwP0lbrmGLuGe_DlhlbdM6fh_xwb2sZ/pub?output=csv";
const PROGRESS_KEY = "clueMatch_simple_v1";
const VIEW_KEY = "clueMatchView";
const STARS_KEY = "clueMatchSetterStars_v1";

const INITIAL_STARS = ["Adam Boyd","Adrian Paris","Adri√°n Par√≠s","Alex Ritter","Amanda C","Andrew Phelps","Annie R","Arbel Feldman","Ayylexis","B N Z","Bill Lash","Billy Frank","CactusKex","Campbell H","Campsite","Cole Baron","Dan Heath","David Hassine","Dean Harding","Doug Thompson","Dr W","Dr_H","Eamonn S","Emilia D","Emily C","Ethan R","Eulerian","Felix H :)","Gabriel K.","Gregory Lewis","hattie","hevorius","HFGO","Holypeanut","Jack Porter","jaimen","Jake Burrow","James & Ollie","Jamie T","Jasel","Jay","JimbieP","Jo J","Jo O","Jody O","Johnny Quarrie","jojo!","jvsn89","Kelly Hicks","Lee Hoe","Lucy","Luminoid","Martin","Mattasdqwe","mattLOLd","maya00","mayasibul00","NatalyBenderskyShalem","Nate Mizelle","NateMiz","Nixfriarr","null","√ìin Stoch","Oren","Pete Bowdon","Pete Craw","Peter Green","Phil McLean","Rob D","Rusty","Ryan Gittins","saintmark_w","Sam Mount (Kaldar)","Schr√∂die‚Äôs Cat","Seivad","sngpretzel","Stevie Reed","Supware","Tanner Burton","That Observer","Tyler Hopp","Tyr","vaughn","ventimony","Bluejay","hurblub"];

let allClues = [], clues = [], currentIndex = 0;
let viewMode = localStorage.getItem(VIEW_KEY) || "all";
let progress = JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{"byId":{}}');
const history = [];

const card = document.getElementById("card");
const flash = document.getElementById("flashMessage");

function buzz(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }
function escapeHtml(s){
  return String(s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* Enumeration from answer; hyphens become e.g. (6-2-3) */
function getEnum(ans) {
  const parts = String(ans||"").split(/\s+/).filter(Boolean).map(w => {
    const hy = w.split('-').filter(Boolean).map(p => (p.match(/[A-Za-z]/g) || []).length);
    return hy.join('-');
  });
  return parts.length ? `(${parts.join(',')})` : "";
}

/* ----- Star system (persistent) ----- */
function getWriterKey(name){ return String(name||"").trim().replace(/\s+/g,' ').toLowerCase(); }

let starMap = {};
function loadStars(){
  try{
    const raw = localStorage.getItem(STARS_KEY);
    starMap = raw ? JSON.parse(raw) : {};
    if(!starMap || typeof starMap !== "object") starMap = {};
  }catch{ starMap = {}; }
}
function saveStars(){
  try{ localStorage.setItem(STARS_KEY, JSON.stringify(starMap)); }catch{}
}
function seedStars(){
  let changed = false;
  for(const n of INITIAL_STARS){
    const k = getWriterKey(n);
    if(!k) continue;
    if(!(k in starMap)){ starMap[k] = true; changed = true; }
  }
  if(changed) saveStars();
}
function isStarSetter(name){ return !!starMap[getWriterKey(name)]; }
function toggleStarSetter(name){
  const k = getWriterKey(name);
  if(!k) return false;
  starMap[k] = !starMap[k];
  saveStars();
  return starMap[k];
}

/* ----- Robust CSV header detection (fixes BOM / renamed columns) ----- */
async function loadSheet() {
  card.style.display = "block";
  card.textContent = "Loading...";

  try {
    const res = await fetch(
      "https://corsproxy.io/?" + encodeURIComponent(SHEET_URL + `&_=${Date.now()}`),
      { cache: "no-store" }
    );
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

    const fields = (parsed.meta && parsed.meta.fields) ? parsed.meta.fields : [];
    const norm = (s) => String(s || "").replace(/^\uFEFF/, "").trim().toLowerCase().replace(/\s+/g, "_");

    const fieldMap = {};
    for (const f of fields) fieldMap[norm(f)] = f;

    const pick = (...cands) => {
      for (const c of cands) {
        const k = norm(c);
        if (fieldMap[k]) return fieldMap[k];
      }
      return "";
    };

    const ID_F      = pick("id", "Id", "uid", "uuid");
    const CLUE_F    = pick("clue", "Clue", "clue_text");
    const ANSWER_F  = pick("answer", "Answer", "solution");
    const WRITER_F  = pick("setter_name", "writer", "setter", "author", "Writer");
    const EMAIL_F   = pick("email", "Email", "setter_email", "writer_email");
    const CREATED_F = pick("created_at", "created", "timestamp");

    allClues = (parsed.data || []).map((r, idx) => {
      const rawId = (ID_F ? r[ID_F] : "") || "";
      const clue = (CLUE_F ? r[CLUE_F] : "") || "";
      const answer = (ANSWER_F ? r[ANSWER_F] : "") || "";
      const writer = (WRITER_F ? r[WRITER_F] : "") || "";
      const email = (EMAIL_F ? r[EMAIL_F] : "") || "";
      const created = (CREATED_F ? r[CREATED_F] : "") || "";

      // Fallback Id keeps app usable if id header is missing/blank
      const id = String(rawId).trim() || (`ROW_${idx}_${created}_${clue}_${answer}`).slice(0, 160);

      return {
        Id: String(id).trim(),
        Clue: String(clue).trim(),
        Answer: String(answer).trim(),
        Writer: String(writer).trim(),
        Email: String(email).trim(),
        Assessment: progress.byId[id]?.Assessment || "",
        Note: progress.byId[id]?.Note || ""
      };
    }).filter(r => r.Clue && r.Answer);

    if (!allClues.length) {
      card.innerHTML =
        `<strong>No rows parsed.</strong><br>` +
        `<span style="font-size:1rem;color:#555">Headers seen: ${escapeHtml(fields.join(" | "))}</span>`;
      document.getElementById("buttons").style.display = "none";
      document.getElementById("progressCount").textContent = "";
      return;
    }

    updateTabs();
    rebuild();
  } catch (e) {
    alert("Load error: " + (e?.message || e));
    card.textContent = "Load error.";
  }
}

function rebuild(keepId="") {
  clues = allClues.filter(c => !c.Assessment);
  if (viewMode === "stars") clues = clues.filter(c => isStarSetter(c.Writer));

  if (keepId) {
    const idx = clues.findIndex(x => x.Id === keepId);
    currentIndex = idx >= 0 ? idx : 0;
  } else {
    currentIndex = 0;
  }

  render();
}

function render() {
  if (!clues.length) {
    card.innerHTML = (viewMode === "stars")
      ? "<strong>No starred clues left!</strong><br><span style='font-size:1rem;color:#555'>Switch to All to keep going.</span>"
      : "<strong>No clues left!</strong>";
    card.style.display = "block";
    document.getElementById("buttons").style.display = "none";
    updateUI();
    return;
  }

  const c = clues[currentIndex];
  const enumText = getEnum(c.Answer);
  const star = isStarSetter(c.Writer) ? `<span id="writerStar">‚≠ê</span>` : "";

  card.innerHTML = `
    <p>${escapeHtml(c.Clue)} <span style="color:#777; font-weight:700">${escapeHtml(enumText)}</span></p>
    <p><strong>Ans:</strong> <span id="answer" onclick="this.classList.toggle('revealed')">${escapeHtml(c.Answer)}</span></p>
    <p id="writer" title="Long-press to star/unstar setter">${escapeHtml(c.Writer)} ${star}</p>
  `;
  card.style.display = "block";
  document.getElementById("buttons").style.display = "flex";

  attachWriterLongPress();
  updateUI();
}

function record(val) {
  const c = clues[currentIndex];
  c.Assessment = val;

  if (!progress.byId[c.Id]) progress.byId[c.Id] = {};
  progress.byId[c.Id].Assessment = val;
  progress.byId[c.Id].Note = c.Note || "";

  history.push(c.Id);
  localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));

  rebuild(); // requeue
}

function undo() {
  const lastId = history.pop();
  if (!lastId) return;

  const c = allClues.find(cl => cl.Id === lastId);
  if (c) c.Assessment = "";

  if (progress.byId[lastId]) delete progress.byId[lastId].Assessment;
  localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));

  rebuild(lastId); // anchor back to undone clue if still eligible
}

function openNote() {
  if (!clues[currentIndex]) return;
  document.getElementById("noteText").value = clues[currentIndex].Note || "";
  document.getElementById("noteOverlay").style.display = "block";
  document.body.classList.add("modal-open");
}

function saveNote() {
  const c = clues[currentIndex];
  c.Note = document.getElementById("noteText").value;

  if (!progress.byId[c.Id]) progress.byId[c.Id] = {};
  progress.byId[c.Id].Note = c.Note;

  localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
  document.getElementById("noteOverlay").style.display = "none";
  document.body.classList.remove("modal-open");
}

function updateUI() {
  const counts = { No:0, Workshop:0, Perfect:0 };
  allClues.forEach(c => { if (counts[c.Assessment] !== undefined) counts[c.Assessment]++; });

  document.getElementById("assessmentCounts").textContent =
    `No: ${counts.No} | Workshop: ${counts.Workshop} | Perfect: ${counts.Perfect}`;

  document.getElementById("progressCount").textContent = `${clues.length} left`;

  const total = allClues.length || 1;
  const done = total - clues.length;
  document.getElementById("progressBar").style.width = `${(done/total)*100}%`;
}

function updateTabs() {
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.view === viewMode));
}

function animateSwipe(dir, cb) {
  buzz();
  card.classList.add(`swipe-${dir}`);
  flash.textContent = {left:'‚ùå', right:'üí°', down:'‚≠ê'}[dir];
  flash.classList.add("show");
  setTimeout(() => { card.className=''; flash.classList.remove("show"); cb(); }, 400);
}

function exportCSV() {
  const data = allClues
    .filter(c => c.Assessment || c.Note)
    .map(c => ({
      id: c.Id,
      clue: c.Clue,
      answer: c.Answer,
      setter: c.Writer,
      email: c.Email || "",
      result: c.Assessment,
      note: c.Note || ""
    }));

  const blob = new Blob(['\ufeff' + Papa.unparse(data)], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "reviews.csv";
  a.click();
}

/* Reset ONLY this app's keys (avoids nuking unrelated localStorage) */
function resetProgress() {
  if (!confirm("Reset app progress? (Assessments + notes)")) return;

  localStorage.removeItem(PROGRESS_KEY);
  // keep stars + view
  progress = { byId: {} };
  history.length = 0;

  loadSheet(); // always reload fresh CSV
}

/* Long-press on writer to star/unstar */
let writerPressHammer = null;
function attachWriterLongPress(){
  const wEl = document.getElementById("writer");
  if(!wEl) return;

  try { writerPressHammer && writerPressHammer.destroy(); } catch {}
  writerPressHammer = new Hammer(wEl);
  writerPressHammer.add(new Hammer.Press({ time: 450 }));

  let pressed = false;

  writerPressHammer.on("press", () => {
    pressed = true;
    buzz(12);

    const c = clues[currentIndex];
    if (!c) { setTimeout(()=>{ pressed=false; }, 0); return; }

    const newState = toggleStarSetter(c.Writer);

    flash.textContent = newState ? "‚≠ê" : "‚òÜ";
    flash.classList.add("show");
    setTimeout(()=>flash.classList.remove("show"),450);

    // If we're in Stars view and we just unstarred them, the clue may disappear from queue
    rebuild(c.Id);

    setTimeout(()=>{ pressed=false; }, 0);
  });

  wEl.addEventListener("click", (e) => {
    if (pressed) {
      e.preventDefault();
      e.stopPropagation();
    }
  });
}

/* Swipe */
const mc = new Hammer(document.body);
mc.get("swipe").set({ direction: Hammer.DIRECTION_ALL });
mc.on("swipeleft", () => animateSwipe('left', () => record('No')));
mc.on("swiperight", () => animateSwipe('right', () => record('Workshop')));
mc.on("swipedown", () => animateSwipe('down', () => record('Perfect')));

/* Tabs */
document.querySelectorAll(".tab").forEach(t => t.onclick = () => {
  viewMode = t.dataset.view;
  localStorage.setItem(VIEW_KEY, viewMode);
  updateTabs();
  rebuild();
});

/* Keyboard support for emoji buttons */
document.querySelectorAll('.emoji-btn').forEach(el=>{
  el.addEventListener('keydown',e=>{
    if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }
  });
});

/* Init */
loadStars();
seedStars();
updateTabs();
window.onload = loadSheet;
</script>
</body>
</html>
